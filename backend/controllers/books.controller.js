const BookService = require("../services/book.service");

/**
 * Class that contains methods to handle CRUD operations on books.
 */
class BookController {

  /**
   * Function to add a new book in the Books model
   * @param {Object} req - Request from client side
   * @param {Object} res - Response generated by the function
   * @returns {Response} response status with a newBook object
   */
  static async addBook(req, res) {
    try {
      let newBook;
      // Check if the book exists or not
      const book = await BookService.findOneBook(req.body.title);

      // If it exists then just update the quantity
      if (book) {
        newBook = BookService.updateQuantity(book, req.body.quantity);
      } else {
        newBook = BookService.addBook(req.body);
      }

      if (!newBook) {
        return res.status(500).json({ message: "Not able to add book" });
      }

      return res.status(201).json({ newBook });
    } catch (error) {
      console.log(error);
    }
  }

  /**
   * Function to get a book with its id and send its details as a response
   * @param {Object} req
   * @param {Object} res
   * @returns {Response} status code with a json message of book details
   */
  static async findBookById(req, res) {
    try {
      const id = req.params.id;
      const book = await BookService.findBookById(id);

      if (!book) {
        return res.status(500).json({ message: "Not able to get book" });
      }

      return res.status(201).json({ book });
    } catch (error) {
      console.log(error);
    }
  }

  /**
   * Function to update the details of a book by getting its id
   * @param {Object} req
   * @param {Object} res
   * @returns {Response} response whether the book has been edited or not
   */
  static async updateBook(req, res) {
    try {
      const id = req.params.id;
      const book = await BookService.updateBook(id, req.body);
      if (!book) {
        return res.status(500).json({ message: "Not able to update book" });
      }

      return res.status(201).json({ message: "Edited successfully" });
    } catch (error) {
      console.log(error);
    }
  }

  /**
   * Function to delete a Book by its ID
   * @param {Object} req
   * @param {Object} res
   * @returns {Response} response status
   */
  static async deleteBook(req, res) {
    try {
      const id = req.params.id;
      const book = await BookService.deleteBook(id);
      if (!book) {
        return res.status(500).json({ message: "Not able to delete book" });
      }
      return res.status(201).json({ message: "Deleted successfully" });
    } catch (error) {
      console.log(error);
    }
  }

  /**
   * Request a new book from admin
   * @param {Request} req
   * @param {Response} res
   */
  static async requestBook(req, res) {
    const result = await BookService.requestBook(req.body);
    res.status(201).json({ result });
  }

  static async getBooks(req, res) {
    const page = Number(req.body.page) || 1;

    // Number fo documents per page
    const limit = Number(req.body.limit) || 5;

    // Formula for pagination, skip is the number of documents to skip from the collection
    const skip = (page - 1) * limit;

    try {
      const books = await BookService.getBooks(skip,limit,req.body.searchQuery,req.body.category);

      const booksCount = await BookService.countBooks(req.body.searchQuery,req.body.category);
      if (!books) {
        return res.status(401).json({ message: "No books found" });
      } else {
        return res.status(200).json({ books: books, booksCount: booksCount });
      }
    } catch (error) {
      console.log(error);
      return res.status(401).json({error: error})
    }
  }
}

module.exports = BookController;
